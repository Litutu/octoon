SET(LIB_NAME hal)
SET(LIB_OUTNAME octoon-${LIB_NAME})

PROJECT(${LIB_OUTNAME})

SET(HEADER_PATH ${OCTOON_PATH_HEADER}/${LIB_NAME})
SET(SOURCE_PATH ${OCTOON_PATH_SOURCE}/${LIB_OUTNAME})

OPTION(OCTOON_FEATURE_HAL_USE_OPENGL20 "On for enable off for disable" ON)
OPTION(OCTOON_FEATURE_HAL_USE_OPENGL30 "On for enable off for disable" ON)
OPTION(OCTOON_FEATURE_HAL_USE_OPENGL32 "On for enable off for disable" ON)
OPTION(OCTOON_FEATURE_HAL_USE_OPENGL33 "On for enable off for disable" ON)
OPTION(OCTOON_FEATURE_HAL_USE_OPENGL45 "On for enable off for disable" ON)
OPTION(OCTOON_FEATURE_HAL_USE_HLSL "On for enable off for disable" OFF)

IF(OCTOON_FEATURE_HAL_USE_OPENGL20)
	ADD_DEFINITIONS(-DOCTOON_FEATURE_HAL_USE_OPENGL20)
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_OPENGL30)
	ADD_DEFINITIONS(-DOCTOON_FEATURE_HAL_USE_OPENGL30)
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_OPENGL32 AND NOT OCTOON_BUILD_PLATFORM_EMSCRIPTEN)
	ADD_DEFINITIONS(-DOCTOON_FEATURE_HAL_USE_OPENGL32)
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_OPENGL33 AND NOT OCTOON_BUILD_PLATFORM_EMSCRIPTEN AND NOT OCTOON_BUILD_PLATFORM_ANDROID)
	ADD_DEFINITIONS(-DGLEW_STATIC)
	ADD_DEFINITIONS(-DOCTOON_FEATURE_HAL_USE_OPENGL33)
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_HLSL)
	ADD_DEFINITIONS(-DOCTOON_FEATURE_HAL_USE_HLSL)
ENDIF()

INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/OpenGL 20")
INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/OpenGL 30")
INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/OpenGL 32")
INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/OpenGL 33")
INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/OpenGL 45")
INCLUDE_DIRECTORIES("${PROJECT_SOURCE_DIR}/OpenGL Common")

IF(OCTOON_BUILD_PLATFORM_EMSCRIPTEN AND NOT OCTOON_BUILD_PLATFORM_ANDROID)
	INCLUDE_DIRECTORIES("${OCTOON_PATH_DEPENDENCIES}/gles/include")
ENDIF()

IF(OCTOON_BUILD_PLATFORM_EMSCRIPTEN)
	INCLUDE_DIRECTORIES("${OCTOON_PATH_DEPENDENCIES}/X11")
ENDIF()

SET(RENDERER_CORE
	${HEADER_PATH}/graphics.h
	${HEADER_PATH}/graphics_child.h
	${SOURCE_PATH}/graphics_child.cpp
	${HEADER_PATH}/graphics_context.h
	${SOURCE_PATH}/graphics_context.cpp
	${HEADER_PATH}/graphics_data.h
	${SOURCE_PATH}/graphics_data.cpp
	${HEADER_PATH}/graphics_descriptor.h
	${SOURCE_PATH}/graphics_descriptor.cpp
	${HEADER_PATH}/graphics_device.h
	${SOURCE_PATH}/graphics_device.cpp
	${HEADER_PATH}/graphics_device_property.h
	${SOURCE_PATH}/graphics_device_property.cpp
	${HEADER_PATH}/graphics_input_layout.h
	${SOURCE_PATH}/graphics_input_layout.cpp
	${HEADER_PATH}/graphics_pipeline.h
	${SOURCE_PATH}/graphics_pipeline.cpp
	${HEADER_PATH}/graphics_resource.h
	${SOURCE_PATH}/graphics_resource.cpp
	${HEADER_PATH}/graphics_sampler.h
	${SOURCE_PATH}/graphics_sampler.cpp
	${HEADER_PATH}/graphics_shader.h
	${SOURCE_PATH}/graphics_shader.cpp
	${HEADER_PATH}/graphics_state.h
	${SOURCE_PATH}/graphics_state.cpp
	${HEADER_PATH}/graphics_swapchain.h
	${SOURCE_PATH}/graphics_swapchain.cpp
	${HEADER_PATH}/graphics_system.h
	${SOURCE_PATH}/graphics_system.cpp
	${HEADER_PATH}/graphics_texture.h
	${SOURCE_PATH}/graphics_texture.cpp
	${HEADER_PATH}/graphics_types.h
	${HEADER_PATH}/graphics_framebuffer.h
	${SOURCE_PATH}/graphics_framebuffer.cpp
	${HEADER_PATH}/graphics_variant.h
	${SOURCE_PATH}/graphics_variant.cpp
)
SOURCE_GROUP("Common" FILES ${RENDERER_CORE})

SET(RENDERER_LIST ${RENDERER_CORE})

FILE(GLOB RENDERER_GL20_HEADER "OpenGL 20/*.h")
FILE(GLOB RENDERER_GL20_SOURCE "OpenGL 20/*.cpp")
FILE(GLOB RENDERER_GL30_HEADER "OpenGL 30/*.h")
FILE(GLOB RENDERER_GL30_SOURCE "OpenGL 30/*.cpp")
FILE(GLOB RENDERER_GL32_HEADER "OpenGL 32/*.h")
FILE(GLOB RENDERER_GL32_SOURCE "OpenGL 32/*.cpp")
FILE(GLOB RENDERER_GL33_HEADER "OpenGL 33/*.h")
FILE(GLOB RENDERER_GL33_SOURCE "OpenGL 33/*.cpp")
FILE(GLOB RENDERER_GL45_HEADER "OpenGL 45/*.h")
FILE(GLOB RENDERER_GL45_SOURCE "OpenGL 45/*.cpp")
FILE(GLOB RENDERER_GL_COMMON_HEADER "OpenGL Common/*.h")
FILE(GLOB RENDERER_GL_COMMON_SOURCE "OpenGL Common/*.cpp")

SET(RENDERER_GL20 ${RENDERER_GL20_HEADER} ${RENDERER_GL20_SOURCE})
SET(RENDERER_GL30 ${RENDERER_GL30_HEADER} ${RENDERER_GL30_SOURCE})
SET(RENDERER_GL32 ${RENDERER_GL32_HEADER} ${RENDERER_GL32_SOURCE})
SET(RENDERER_GL33 ${RENDERER_GL33_HEADER} ${RENDERER_GL33_SOURCE})
SET(RENDERER_GL45 ${RENDERER_GL45_HEADER} ${RENDERER_GL45_SOURCE})
SET(RENDERER_GL_COMMON ${RENDERER_GL_COMMON_HEADER} ${RENDERER_GL_COMMON_SOURCE})

IF(NOT OCTOON_BUILD_PLATFORM_APPLE)
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/nsgl_swapchain.h")
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/nsgl_swapchain.mm")
ENDIF()

IF(NOT OCTOON_BUILD_PLATFORM_LINUX)
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/x11_swapchain.h")
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/x11_swapchain.cpp")
ENDIF()

IF(NOT OCTOON_BUILD_PLATFORM_WINDOWS)
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/wgl_swapchain.h")
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/wgl_swapchain.cpp")
ENDIF()

IF(NOT OCTOON_BUILD_PLATFORM_ANDROID AND NOT OCTOON_BUILD_PLATFORM_EMSCRIPTEN)
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/egl_swapchain.h")
	LIST(REMOVE_ITEM RENDERER_GL_COMMON "${SOURCE_PATH}/OpenGL Common/egl_swapchain.cpp")
ENDIF()

SOURCE_GROUP("OpenGL 20" FILES ${RENDERER_GL20})
SOURCE_GROUP("OpenGL 30" FILES ${RENDERER_GL30})
SOURCE_GROUP("OpenGL 32" FILES ${RENDERER_GL32})
SOURCE_GROUP("OpenGL 33" FILES ${RENDERER_GL33})
SOURCE_GROUP("OpenGL 45" FILES ${RENDERER_GL45})
SOURCE_GROUP("OpenGL Common" FILES ${RENDERER_GL_COMMON})

IF(OCTOON_FEATURE_HAL_USE_OPENGL20)
	LIST(APPEND RENDERER_LIST ${RENDERER_GL20})
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_OPENGL30)
	LIST(APPEND RENDERER_LIST ${RENDERER_GL30})
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_OPENGL32 AND NOT OCTOON_BUILD_PLATFORM_EMSCRIPTEN AND NOT OCTOON_BUILD_PLATFORM_ANDROID)
	LIST(APPEND RENDERER_LIST ${RENDERER_GL32})
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_OPENGL33 AND NOT OCTOON_BUILD_PLATFORM_EMSCRIPTEN AND NOT OCTOON_BUILD_PLATFORM_ANDROID)
	LIST(APPEND RENDERER_LIST ${RENDERER_GL33})
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_OPENGL45 AND NOT OCTOON_BUILD_PLATFORM_EMSCRIPTEN AND NOT OCTOON_BUILD_PLATFORM_ANDROID)
	LIST(APPEND RENDERER_LIST ${RENDERER_GL45})
ENDIF()

LIST(APPEND RENDERER_LIST ${RENDERER_GL_COMMON})

IF(OCTOON_BUILD_PLATFORM_APPLE)
	SET_SOURCE_FILES_PROPERTIES(${RENDERER_LIST} PROPERTIES LANGUAGE CXX)
ENDIF()

IF(OCTOON_BUILD_SHARED_DLL)
	ADD_DEFINITIONS(-DOCTOON_BUILD_DLL_EXPORT)
	ADD_LIBRARY(${LIB_OUTNAME} SHARED ${RENDERER_LIST})
ELSE()
	ADD_DEFINITIONS(-DOCTOON_STATIC)
	ADD_LIBRARY(${LIB_OUTNAME} ${RENDERER_LIST})
ENDIF()

TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE octoon-runtime)

IF(OCTOON_BUILD_PLATFORM_APPLE)
	FIND_LIBRARY(COCOA_FRAMEWORK Cocoa)
	FIND_LIBRARY(OPENGL_FRAMEWORK OpenGL)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE ${COCOA_FRAMEWORK})
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE ${OPENGL_FRAMEWORK})
ELSEIF(OCTOON_BUILD_PLATFORM_LINUX)
	FIND_PACKAGE(OpenGL REQUIRED)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE X11)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE ${OPENGL_LIBRARIES})
ELSEIF(OCTOON_BUILD_PLATFORM_ANDROID)
    TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE libEGL)
    TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE libGLESv2)
ELSEIF(OCTOON_BUILD_PLATFORM_EMSCRIPTEN)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE EGL)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE GLESv2)
ENDIF()

IF(NOT OCTOON_BUILD_PLATFORM_EMSCRIPTEN AND NOT OCTOON_BUILD_PLATFORM_ANDROID)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE glew)
ENDIF()

IF(OCTOON_FEATURE_HAL_USE_HLSL)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE d3dcompiler)
	TARGET_LINK_LIBRARIES(${LIB_OUTNAME} PRIVATE libHLSLcc)
ENDIF()

SET_TARGET_ATTRIBUTE(${LIB_OUTNAME} "core")